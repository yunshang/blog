<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>alshin - 一个客服端应用</title>
    <meta name="description" content="">

    <link rel="stylesheet" href="/blog/assets/css/bootstrap.css">
    <link rel="stylesheet" href="/blog/assets/css/animate.css">
    <link rel="stylesheet" href="/blog/assets/css/font-awesome.min.css">
    <link rel="stylesheet" href="/blog/assets/css/font.css">
    <link rel="stylesheet" href="/blog/assets/css/landing.css">
    <link rel="stylesheet" href="/blog/assets/css/app.css">
    <link rel="stylesheet" href="/blog/assets/css/highlight.css">
    <link rel="stylesheet" href="/blog/assets/css/custom.css">

    <link rel="canonical" href="/blog/ruby/2016/09/17/the%20client%20application.html">
    <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan style='display:none;' id='cnzz_stat_icon_1259096643'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1259096643' type='text/javascript'%3E%3C/script%3E"));</script>
</head>

    <body>
        <section id="wrapper">
            <article class="post">
                <header>
                    <h1>一个客服端应用</h1>
                    <h2 class="headline">17 Sep 2016</h2>
                </header>
                <section id="post-body">
                    <blockquote>
<p>第一篇我们构建了Oauth 服务应用,现在我们创建一个发客服端应用。</p>
</blockquote>

<h3 id="omniauth-oauth2-gem-允许我们在试用oauth2的时候，仅通过一个简单的配置文件-strategy-就可以办到。">omniauth-oauth2 gem,允许我们在试用Oauth2的时候，仅通过一个简单的配置文件(strategy)就可以办到。</h3>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">&#39;omniauth-oauth2&#39;</span>
</code></pre></div>
<h3 id="omniauth-是一个通用gem-它允许程序员用它使用各种oath提供者，通过不同的配置。">Omniauth 是一个通用gem,它允许程序员用它使用各种oath提供者，通过不同的配置。</h3>

<h3 id="在lib下创建doorkeeper-rb">在lib下创建doorkeeper.rb</h3>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;omniauth-oauth2&#39;</span>

<span class="k">module</span> <span class="nn">OmniAuth</span>
  <span class="k">module</span> <span class="nn">Strategies</span>
    <span class="k">class</span> <span class="nc">Doorkeeper</span> <span class="o">&lt;</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Strategies</span><span class="o">::</span><span class="no">OAuth2</span>
      <span class="n">option</span> <span class="ss">:name</span><span class="p">,</span> <span class="s1">&#39;doorkeeper&#39;</span>
      <span class="n">option</span> <span class="ss">:client_options</span><span class="p">,</span> <span class="p">{</span>
        <span class="ss">site</span><span class="p">:</span>          <span class="s1">&#39;http://localhost:3000&#39;</span><span class="p">,</span>
        <span class="ss">authorize_url</span><span class="p">:</span> <span class="s1">&#39;http://localhost:3000/oauth/authorize&#39;</span>
      <span class="p">}</span>

      <span class="n">uid</span> <span class="p">{</span>
        <span class="n">raw_info</span><span class="o">[</span><span class="s1">&#39;id&#39;</span><span class="o">]</span>
      <span class="p">}</span>

      <span class="n">info</span> <span class="k">do</span>
        <span class="p">{</span>
          <span class="ss">email</span><span class="p">:</span> <span class="n">raw_info</span><span class="o">[</span><span class="s1">&#39;email&#39;</span><span class="o">]</span><span class="p">,</span>
        <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">extra</span> <span class="k">do</span>
        <span class="p">{</span> <span class="ss">raw_info</span><span class="p">:</span> <span class="n">raw_info</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">raw_info</span>
        <span class="vi">@raw_info</span> <span class="o">||=</span> <span class="n">access_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/me&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">parsed</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="再生成omniauth的配置文件">再生成omniauth的配置文件</h3>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">touch</span> <span class="n">config</span><span class="o">/</span><span class="n">initializers</span><span class="o">/</span><span class="n">omniauth</span><span class="o">.</span><span class="n">rb</span>
</code></pre></div><div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;doorkeeper&#39;</span>

<span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Builder</span> <span class="k">do</span>
  <span class="n">provider</span> <span class="ss">:doorkeeper</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">application_id</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">application_secret</span><span class="o">&gt;</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="application_id-和-application_secret-填入上一篇文章中得到的值。">application_id 和 application_secret 填入上一篇文章中得到的值。</h3>

<h3 id="配置路由">配置路由</h3>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span> <span class="ss">to</span><span class="p">:</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/auth/doorkeeper&#39;</span><span class="p">)</span>

    <span class="n">get</span> <span class="s1">&#39;/auth/:provider/callback&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;application#authentication_callback&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div>
<h3 id="第一行doorkeeper的认证路由，将会被omniauth处理，第二行服务器的回调地址，将会有身份验证。">第一行doorkeeper的认证路由，将会被omniauth处理，第二行服务器的回调地址，将会有身份验证。</h3>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span>
    <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="n">auth</span><span class="o">.</span><span class="n">to_json</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div>
<h3 id="参考资料">参考资料</h3>

<ul>
<li><p><a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html">http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html</a></p></li>
<li><p><a href="https://ruby-china.org/topics/14656">https://ruby-china.org/topics/14656</a></p></li>
<li><p><a href="http://linjunzhu.github.io/blog/2014/09/21/doorkeepershi-yong-jian-jie/">http://linjunzhu.github.io/blog/2014/09/21/doorkeepershi-yong-jian-jie/</a></p></li>
</ul>

                </section>
            </article>

            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'alshin';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            <footer id="footer">
                <div id="social">
                    <a class="symbol" href="https://github.com/yundshang">
                      <i class="fa fa-github"></i>
                    </a>
                    <a class="symbol" href="https://twitter.com">
                      <i class="fa fa-twitter"></i>
                    </a>
                    <a class="symbol" href="http://weibo.com">
                      <i class="fa fa-weibo"></i>
                    </a>
                </div>
                <p class="small">
                    © 版权所有 alshin
                </p>
            </footer>
        </section>

    </body>
</html>
